import { createClient } from '@supabase/supabase-js';

// Get environment variables
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL || 'https://your-project.supabase.co';
const supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'your-anon-key';

const supabase = createClient(supabaseUrl, supabaseKey);

async function testQuotationOwnershipFix() {
  console.log('ğŸ§ª TESTING QUOTATION OWNERSHIP FIX');
  console.log('='.repeat(50));
  
  try {
    // 1. TEST: Verify employees in sales department
    console.log('\n1ï¸âƒ£ TESTING: Sales employees query');
    const { data: salesEmployees } = await supabase
      .from('employees')
      .select('id, name, email, department_id')
      .eq('department_id', 2);
    
    console.log(`âœ… Found ${salesEmployees?.length || 0} sales employees:`);
    salesEmployees?.forEach(emp => {
      console.log(`  â€¢ ID: ${emp.id}, Name: ${emp.name}, Dept: ${emp.department_id}`);
    });
    
    // 2. TEST: Check quotation assignment
    console.log('\n2ï¸âƒ£ TESTING: Quotation assignment');
    const { data: quotations } = await supabase
      .from('quotations')
      .select('id, quotation_number, client_name, total_amount, status, created_by, assigned_to')
      .order('created_at', { ascending: false });
    
    console.log(`âœ… Found ${quotations?.length || 0} quotations:`);
    quotations?.forEach(q => {
      const createdByVikas = q.created_by === "87" || q.created_by === 87;
      const assignedToVikas = q.assigned_to === 87;
      console.log(`  â€¢ ${q.quotation_number}: ${q.client_name}`);
      console.log(`    Amount: â‚¹${q.total_amount}, Status: ${q.status}`);
      console.log(`    Created by: ${q.created_by} ${createdByVikas ? 'âœ… (Vikas)' : 'âŒ (Not Vikas)'}`);
      console.log(`    Assigned to: ${q.assigned_to} ${assignedToVikas ? 'âœ… (Vikas)' : 'âŒ (Not Vikas)'}`);
    });
    
    // 3. TEST: Check leads assignment  
    console.log('\n3ï¸âƒ£ TESTING: Lead assignment');
    const { data: leads } = await supabase
      .from('leads')
      .select('id, client_name, assigned_to, status')
      .order('created_at', { ascending: false });
    
    console.log(`âœ… Found ${leads?.length || 0} leads:`);
    leads?.forEach(lead => {
      const assignedToVikas = lead.assigned_to === 87;
      console.log(`  â€¢ ID: ${lead.id}, Client: ${lead.client_name}`);
      console.log(`    Assigned to: ${lead.assigned_to} ${assignedToVikas ? 'âœ… (Vikas)' : 'âŒ (Not Vikas)'}, Status: ${lead.status}`);
    });
    
    // 4. TEST: Calculate expected team performance
    console.log('\n4ï¸âƒ£ TESTING: Team performance calculation');
    
    // Filter quotations for Vikas
    const vikasQuotations = quotations?.filter(q => {
      return q.created_by === "87" || q.created_by === 87 || q.assigned_to === 87;
    }) || [];
    
    // Filter leads for Vikas  
    const vikasLeads = leads?.filter(l => l.assigned_to === 87) || [];
    
    // Calculate metrics
    const convertedQuotations = vikasQuotations.filter(q => 
      q.status === 'approved' || q.status === 'completed' || q.status === 'pending_approval'
    );
    
    const totalRevenue = vikasQuotations.reduce((sum, q) => sum + (q.total_amount || 0), 0);
    const conversionRate = vikasQuotations.length > 0 ? convertedQuotations.length / vikasQuotations.length : 0;
    
    console.log(`ğŸ“Š Vikas Alagarsamy Performance:`);
    console.log(`  â€¢ Leads assigned: ${vikasLeads.length}`);
    console.log(`  â€¢ Quotations created: ${vikasQuotations.length}`);
    console.log(`  â€¢ Quotations converted: ${convertedQuotations.length}`);
    console.log(`  â€¢ Total revenue: â‚¹${totalRevenue.toLocaleString()}`);
    console.log(`  â€¢ Conversion rate: ${(conversionRate * 100).toFixed(1)}%`);
    
    // 5. EXPECTED RESULTS
    console.log('\n5ï¸âƒ£ EXPECTED vs ACTUAL:');
    console.log(`Expected results after fix:`);
    console.log(`  â€¢ Vikas should have 1 lead âœ…`);
    console.log(`  â€¢ Vikas should have 1 quotation (â‚¹43,500) âœ…`);
    console.log(`  â€¢ Quotation should be assigned to Vikas âœ…`);
    console.log(`  â€¢ Team Performance should show â‚¹43,500 revenue âœ…`);
    
    const success = (
      vikasLeads.length >= 1 &&
      vikasQuotations.length >= 1 &&
      totalRevenue >= 43500
    );
    
    console.log(`\nğŸ¯ OVERALL TEST RESULT: ${success ? 'âœ… PASSED' : 'âŒ FAILED'}`);
    
    if (!success) {
      console.log('\nâŒ Issues found:');
      if (vikasLeads.length === 0) console.log('  â€¢ No leads assigned to Vikas');
      if (vikasQuotations.length === 0) console.log('  â€¢ No quotations assigned to Vikas');
      if (totalRevenue < 43500) console.log('  â€¢ Revenue is less than expected â‚¹43,500');
    }
    
    return success;
    
  } catch (error) {
    console.error('âŒ Test error:', error);
    return false;
  }
}

// Run the test
testQuotationOwnershipFix().then(success => {
  console.log(`\n${success ? 'ğŸ‰ ALL TESTS PASSED!' : 'ğŸ’¥ TESTS FAILED!'}`);
  process.exit(success ? 0 : 1);
}); 